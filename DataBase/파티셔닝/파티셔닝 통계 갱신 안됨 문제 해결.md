# 파티셔닝 통계 갱신 안됨 문제 해결

>

---

## 학습 개요 

##### 문제 발생

- 파티셔닝 테이블을 핸들링 하던 중 `REORGANIZE PARTITION` 을 사용하려 파티셔닝을 분할하고 있었다. 

- 그런데 **순서에 따라`patitions 의 Table rows` 에 값이 표출되기도 하고 안되기도 하는 문제가 발생했다.** 

  1. 파티셔닝 생성 -> 데이터를 삽입 : 표출 O

  2. 데이터 삽입 -> 파티셔닝 생성 & 분할  : 표출 X

- 처음엔 파티셔닝이 적용되지 않아 데이터가 누락된줄 알았으나, 데이터는 재대로 존재하고 있어서 이유를 모르겠었다. 

- 그러다가 통계정보에만 반영이 안된다는 것을 알게 되어 해당 내용을 정리하고자 한다. 

##### 문제 해결 

- 내가 사용한 방법은 통계정보를 갱신하는 명령어였다. 
- `ANALYZE TABLE daegu5g_dev.TB_ED_HT_EVENT_TEST;`  명령은 **파티션 구조를 변경하지 않고**,  **통계 정보(statistics)** 만 갱신하는 명령이다.

## 결론

> `ANALYZE TABLE` 전에도 파티셔닝은 이미 정상 적용되어 있으며,
>  이 명령은 단지 **통계 정보 갱신용**이다.
>
> 따라서 `TABLE_ROWS`가 0으로 보여도 데이터는 실제로 존재하며,
>  `ANALYZE TABLE` 실행 후 최신 통계로 갱신되어 정확히 표시된다.

## 동작 원리

| 항목                | 설명                                                         |
| ------------------- | ------------------------------------------------------------ |
| 명령 목적           | 옵티마이저가 사용할 통계 정보 갱신                           |
| 영향을 받는 대상    | 각 파티션, 인덱스, 데이터 분포 통계                          |
| 실제 데이터 이동    | ❌ 없음                                                       |
| 파티션 구조 변경    | ❌ 없음                                                       |
| 메타데이터 업데이트 | `information_schema.PARTITIONS` 테이블의 `TABLE_ROWS`, `DATA_LENGTH` 등 갱신 |

## TABLE_ROWS 가 0으로 나오는 이유

- `information_schema.PARTITIONS.TABLE_ROWS` 는 **실제 row count가 아닌 “추정치”**  
- InnoDB 엔진은 통계 정보를 **즉시 갱신하지 않음**
- 그래서 파티션에 데이터가 있어도 **`TABLE_ROWS=0` 으로 표시**될 수 있음

##  ANALYZE TABLE 의 효과

| 항목               | 실행 전    | 실행 후                   |
| ------------------ | ---------- | ------------------------- |
| 파티션 데이터 존재 | ✅ 있음     | ✅ 그대로 있음             |
| TABLE_ROWS 표시    | 0 (미갱신) | ✅ 실제 값에 근접한 추정치 |
| 데이터 재배치      | ❌ 없음     | ❌ 없음                    |
| 통계 정보          | 오래된 값  | ✅ 최신 통계로 업데이트    |

## 실제 예시

```sql
-- 파티션별 추정 행수 보기
SELECT PARTITION_NAME, TABLE_ROWS
FROM information_schema.PARTITIONS
WHERE TABLE_SCHEMA='test'
  AND TABLE_NAME='TB_ED_HT_EVENT_TEST';/;ㅔ

-- 실제 행수 보기
SELECT COUNT(*) FROM test.TB_ED_HT_EVENT_TEST PARTITION (p202510);

-- 파티션 분할 적용 
ALTER TABLE test.TB_ED_HT_EVENT_TEST
REORGANIZE PARTITION p202510 INTO (
  PARTITION p202509 VALUES LESS THAN ('202510010000000'),
  PARTITION p202510 VALUES LESS THAN ('202511010000000')
);

-- 통계 갱신
ANALYZE TABLE test.TB_ED_HT_EVENT_TEST;

-- 다시 확인
SELECT PARTITION_NAME, TABLE_ROWS
FROM information_schema.PARTITIONS
WHERE TABLE_SCHEMA='test'
  AND TABLE_NAME='TB_ED_HT_EVENT_TEST';
```

## 정리 요약

| 항목                    | 설명                                           |
| ----------------------- | ---------------------------------------------- |
| 파티션 적용 시점        | `ALTER TABLE ... PARTITION ...` 실행 완료 즉시 |
| ANALYZE TABLE 실행 목적 | 통계(추정치) 갱신                              |
| 데이터 손실 가능성      | ❌ 없음                                         |
| TABLE_ROWS 0 현상       | 통계 미갱신 상태                               |
| 해결 방법               | `ANALYZE TABLE` 실행                           |
| 파티션 재적용 필요 여부 | ❌ 없음 (이미 적용 완료 상태)                   |

