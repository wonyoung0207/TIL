## gitlab-ci.yml

```yml
# ÌååÏù¥ÌîÑÎùºÏù∏ Îã®Í≥Ñ Ï†ïÏùò
stages:
  - build-check
  - notification-hook
  - deploy
  - notification-deploy-hook

# ÌîÑÎ°†Ìä∏ ÎπåÎìú ÏûëÏóÖ (node.js, npm, nvm ÌïÑÏöî)
frontend-build:
  stage: build-check
  image: node:14.17-alpine
  script:
    - echo "üì¶ node install & build frontend"
    - cd frontend
     # Ï∫êÏãúÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ npm ci Ïã§Ìñâ
    - if [ -d node_modules ] && [ "$(ls -A node_modules)" ]; then
        echo "‚úÖ Using cached node_modules";
      else
        echo "üìÇ No cache found, running npm ci";
        npm ci || npm install --legacy-peer-deps;
      fi  
    - npm run build
    - echo "‚úÖ frontend Build Success"
    # - echo "üìÇ Ï∫êÏãú ÌååÏùº Ï†ÑÏ≤¥ Í≤ΩÎ°ú ÌÉêÏÉâ"
    # - find /cache -type f
    # - echo "üìÇ /cache ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞ Ï†ÑÏ≤¥ Î≥¥Í∏∞"
    # - tree /cache || echo "tree Î™ÖÎ†πÏñ¥ ÏóÜÏùå"
    # - echo "üìÇ Ï∫êÏãú ÌååÏùº ÎîîÎ≤ÑÍπÖ - /cache Í≤ΩÎ°ú ÌôïÏù∏"
    # - ls -al /cache || echo "/cache ÎîîÎ†âÌÜ†Î¶¨ ÏóÜÏùå"
    # - echo "üìÇ Ï∫êÏãú ÌååÏùº ÎîîÎ≤ÑÍπÖ - ÌòÑÏû¨ ÏûëÏóÖ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏"
    - pwd
    - ls -al
  cache:
    # key: frontend-node-modules
    key:
      files:
        - package-lock.json
    paths:
      - frontend/node_modules/
    policy: pull-push
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  tags:
    - klever-twin-runner


# Î∞±ÏóîÎìú ÎπåÎìú ÏûëÏóÖ (java, gradle ÌïÑÏöî) 
backend-build:
  stage: build-check
  image: gradle:7.6.1-jdk17
  script:
    - echo "üì¶ Clean & build backend"
    - cd backend/dt
    - ./gradlew --no-daemon clean build
    - echo "‚úÖ Backend Build Success"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  tags:
    - klever-twin-runner


# ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞∞Ìè¨ ÏûëÏóÖ (node.js, npm, nvm ÌïÑÏöî)
frontend-deploy:
  stage: deploy
  image: node:14.17-alpine
  script:
    - echo "üì¶ Install & build frontend"
    - cd frontend
     # Ï∫êÏãúÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ npm ci Ïã§Ìñâ
    - if [ -d node_modules ] && [ "$(ls -A node_modules)" ]; then
        echo "‚úÖ Using cached node_modules";
      else
        echo "üìÇ No cache found, running npm ci";
        npm ci || npm install --legacy-peer-deps;
      fi
    - npm run build
    - mkdir -p /output/frontend
    - cp -r twin/* /output/frontend/
    - ls -lh /output/frontend
    - echo "‚úÖ Frontend Deploy Success"
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - frontend/node_modules/
    policy: pull-push
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"
  tags:
    - klever-twin-runner


# Î∞±ÏóîÎìú Î∞∞Ìè¨ ÏûëÏóÖ (java, gradle ÌïÑÏöî) 
backend-deploy: 
  stage: deploy
  image: gradle:7.6.1-jdk17
  script:
      - echo "üì¶ Clean & build backend"
      - cd backend/dt
      - ./gradlew --no-daemon clean build
      - mkdir -p /output/backend
      - cp build/libs/*.jar /output/backend/  # ‚¨Ö ÎßàÏö¥Ìä∏Îêú Í≤ΩÎ°úÎ°ú Î≥µÏÇ¨
      - ls -lh /output/backend
      - echo "‚úÖ Backend Deploy Success"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"
  tags:
    - klever-twin-runner
 


############################## ÏïåÎûå ##############################

# frontend , backend ÎπåÎìú ÏÑ±Í≥µÏãú Ïã§Ìñâ
notify-build-success:
  stage: notification-hook
  image: alpine/curl:latest
  needs: 
  - job: frontend-build
    artifacts: false
  - job: backend-build
    artifacts: false
  before_script:
  - apk add --no-cache jq
  script:
    - |
      BRANCH_NAME=${CI_COMMIT_BRANCH:-${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}}
      echo "üëâ merge ID : CI_MERGE_REQUEST_IID = $CI_MERGE_REQUEST_IID"
      echo "üëâ API URL : CI_API_V4_URL = $CI_API_V4_URL"
      echo "üëâ Project ID : CI_PROJECT_ID = $CI_PROJECT_ID"
      echo "üëâ Token : GITLAB_API_TOKEN = $GITLAB_API_TOKEN"
      echo "üëâ API CALL URL: $CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID"

      echo "üì¶ Î¶¨Î∑∞Ïñ¥ Ï†ïÎ≥¥ Ï°∞Ìöå (GitLab API)"
      REVIEWERS_JSON=$(curl --silent --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/merge_requests/$CI_MERGE_REQUEST_IID")

      # API Ìò∏Ï∂ú Ïã§Ìå® Ïãú
      if [ -z "$REVIEWERS_JSON" ] || [ "$REVIEWERS_JSON" = "null" ]; then
        echo "üö® API Ìò∏Ï∂ú Ïã§Ìå® ÎòêÎäî Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"
        REVIEWERS="(Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®)"
        echo "‚úÖ ÏµúÏ¢Ö Î¶¨Î∑∞Ïñ¥ Î™©Î°ù: $REVIEWERS"
        exit 0
      fi

      # reviewers ÌïÑÎìú ÌååÏã± Î∞è null Î∞©Ïñ¥
      REVIEWERS=$(echo "$REVIEWERS_JSON" | jq -r '[.reviewers[]?.name] | select(length > 0) | join(", ")')

      # reviewersÍ∞Ä ÎπÑÏñ¥ÏûàÎã§Î©¥ Í∏∞Î≥∏Í∞í Ï≤òÎ¶¨
      if [ -z "$REVIEWERS" ]; then
        REVIEWERS="(ÏßÄÏ†ïÎêòÏßÄ ÏïäÏùå)"
      fi

      echo "‚úÖ ÏµúÏ¢Ö Î¶¨Î∑∞Ïñ¥ Î™©Î°ù: $REVIEWERS"

      MESSAGE="
        <b>[ Klever Twin ÏïåÎ¶º ]</b>%0A\
        üîî <b>Merge Request Opened</b> üîî %0A\
        <b>Project:</b> ${CI_PROJECT_NAME}%0A\
        <b>Author:</b> ${GITLAB_USER_NAME}%0A\
        <b>Reviewer:</b> ${REVIEWERS}%0A\
        <b>Branch:</b> <code>${BRANCH_NAME}</code>%0A\
        <b>Pipeline:</b> <code>${CI_PIPELINE_ID}</code>%0A\
        <b>Title:</b> ${CI_MERGE_REQUEST_TITLE}%0A\
        <b>Link:</b> ${CI_MERGE_REQUEST_PROJECT_URL}/-/merge_requests/${CI_MERGE_REQUEST_IID}"

      URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
      echo "Telegram API URL: $URL"
      echo "Telegram Chat ID: ${TELEGRAM_CHAT_ID}"
      echo -e "Telegram Message:\n$MESSAGE"

      curl -s -X POST "$URL" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="$MESSAGE"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_success
  tags: 
    - klever-twin-runner



# ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú Ïã§Ìå®Ïãú ÏïåÎ¶º
notify-frontend-build-failure:
  stage: notification-hook
  image: alpine/curl:latest
  needs: ["frontend-build"]
  script:
    - |
      MESSAGE="
        <b> [ Klever Twin ÏïåÎ¶º ] </b>%0A\
        üö® <b>Frontend ÎπåÎìú Ïã§Ìå®</b> üö® %0A\
        <pre>\
        Project     : ${CI_PROJECT_NAME}
        MR Title    : ${CI_MERGE_REQUEST_TITLE}
        Branch      : ${CI_COMMIT_REF_NAME}
        Commit      : ${CI_COMMIT_SHORT_SHA}
        Author      : ${GITLAB_USER_NAME}
        Job URL     : ${CI_JOB_URL}
        </pre>
      "

      URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
      echo "Telegram API URL: $URL"
      echo "Telegram Chat ID: ${TELEGRAM_CHAT_ID}"
      echo -e "Telegram Message:\n$MESSAGE"

      curl -s -X POST "$URL" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="$MESSAGE"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_failure
  tags: 
    - klever-twin-runner


# Î∞±ÏóîÎìú ÎπåÎìú Ïã§Ìå®Ïãú ÏïåÎ¶º
notify-backend-build-failure:
  stage: notification-hook
  image: alpine/curl:latest
  needs: ["backend-build"]
  script:
    - |
      MESSAGE="
        <b> [ Klever Twin ÏïåÎ¶º ] </b>%0A\
        üö® <b>Backend ÎπåÎìú Ïã§Ìå®</b> üö® %0A\
        <pre>\
        Project     : ${CI_PROJECT_NAME}
        MR Title    : ${CI_MERGE_REQUEST_TITLE}
        Branch      : ${CI_COMMIT_REF_NAME}
        Commit      : ${CI_COMMIT_SHORT_SHA}
        Author      : ${GITLAB_USER_NAME}
        Job URL     : ${CI_JOB_URL}
        </pre>
      "

      URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
      echo "Telegram API URL: $URL"
      echo "Telegram Chat ID: ${TELEGRAM_CHAT_ID}"
      echo -e "Telegram Message:\n$MESSAGE"

      curl -s -X POST "$URL" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="$MESSAGE"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: on_failure
  tags: 
    - klever-twin-runner

# ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞∞Ìè¨ ÏÑ±Í≥µÏãú ÏïåÎ¶º
notify-deploy-success:
  stage: notification-deploy-hook
  image: alpine/curl:latest
  needs: 
  - job: frontend-deploy
    artifacts: false
  - job: backend-deploy
    artifacts: false
  script:
    - |
      DEPLOY_PATH="/mnt/d/build/"
      MESSAGE="
        <b>[ Klever Twin ÏïåÎ¶º ]</b>%0A\
        ‚úÖ <b>Frontend, Backend Deploy Success</b> ‚úÖ %0A\
        <pre>\
        Target Host  : 172.28.7.160
        Project      : ${CI_PROJECT_NAME}
        Author       : ${GITLAB_USER_NAME}
        Branch       : ${CI_COMMIT_BRANCH}
        Pipeline     : ${CI_PIPELINE_ID}
        Deploy Path  : ${DEPLOY_PATH}
        </pre>"
      URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
      echo "Telegram API URL: $URL"
      echo "Telegram Chat ID: ${TELEGRAM_CHAT_ID}"
      echo -e "Telegram Message:\n$MESSAGE"

      curl -s -X POST "$URL" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="$MESSAGE"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"
      when: on_success
  tags: 
    - klever-twin-runner

# ÌîÑÎ°†Ìä∏ Î∞∞Ìè¨ Ïã§Ìå®Ïãú ÏïåÎ¶º
notify-frontend-deploy-failure:
  stage: notification-deploy-hook
  image: alpine/curl:latest
  needs: ["frontend-deploy"]
  script:
    - |
      MESSAGE="
        <b> [ Klever Twin ÏïåÎ¶º ] </b>%0A\
        üö® <b>Frontend Î∞∞Ìè¨ Ïã§Ìå®</b> üö® %0A\
        <pre>\
        Project     : ${CI_PROJECT_NAME}
        MR Title    : ${CI_MERGE_REQUEST_TITLE}
        Branch      : ${CI_COMMIT_REF_NAME}
        Commit      : ${CI_COMMIT_SHORT_SHA}
        Author      : ${GITLAB_USER_NAME}
        Job URL     : ${CI_JOB_URL}
        </pre>
      "

      URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
      echo "Telegram API URL: $URL"
      echo "Telegram Chat ID: ${TELEGRAM_CHAT_ID}"
      echo -e "Telegram Message:\n$MESSAGE"

      curl -s -X POST "$URL" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="$MESSAGE"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"
      when: on_failure
  tags: 
    - klever-twin-runner


# Î∞±ÏóîÎìú Î∞∞Ìè¨ Ïã§Ìå®Ïãú ÏïåÎ¶º
notify-backend-deploy-failure:
  stage: notification-deploy-hook
  image: alpine/curl:latest
  needs: ["backend-deploy"]
  script:
    - |
      MESSAGE="
        <b> [ Klever Twin ÏïåÎ¶º ] </b>%0A\
        üö® <b>Backend Î∞∞Ìè¨ Ïã§Ìå®</b> üö® %0A\
        <pre>\
        Project     : ${CI_PROJECT_NAME}
        MR Title    : ${CI_MERGE_REQUEST_TITLE}
        Branch      : ${CI_COMMIT_REF_NAME}
        Commit      : ${CI_COMMIT_SHORT_SHA}
        Author      : ${GITLAB_USER_NAME}
        Job URL     : ${CI_JOB_URL}
        </pre>
      "

      URL="https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
      echo "Telegram API URL: $URL"
      echo "Telegram Chat ID: ${TELEGRAM_CHAT_ID}"
      echo -e "Telegram Message:\n$MESSAGE"

      curl -s -X POST "$URL" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d parse_mode="HTML" \
        -d text="$MESSAGE"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"
      when: on_failure
  tags: 
    - klever-twin-runner

# deploy-to-local:
#   stage: deploy
#   script:
#     - scp backend/dt/build/libs/*.jar user@host:/path/to/deploy/
#   rules:
#     - if: $CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE == "push"
#   only:
#     - dev
#   tags:
#     - docker-runner


# NCP Docker Context Î∞∞Ìè¨ ÏûëÏóÖ
# result-deploy:
#   stage: deploy
#   image:
#     name: docker:24.0.2-dind-alpine3.18
#     entrypoint: [""]
#   services:
#     - name: docker:20-dind
#       command: ["--host=tcp://0.0.0.0:2375"]
#   before_script:
#     - echo "$PASSWORD" | docker login --username "$USERNAME" --password-stdin "$DOCKER_REGISTRY"
#   script:
#     - echo "üì¶ ncp Connected ... Docker context"
#     - docker build -t ${DOCKER_REGISTRY}/klever-gitlab-runner:r${CI_PIPELINE_IID} .
#     - docker tag ${DOCKER_REGISTRY}/klever-gitlab-runner:r${CI_PIPELINE_IID} ${DOCKER_REGISTRY}/klever-gitlab-runner:latest
#     - docker push ${DOCKER_REGISTRY}/klever-gitlab-runner:r${CI_PIPELINE_IID}
#     - docker push ${DOCKER_REGISTRY}/klever-gitlab-runner:latest
#   dependencies:
#     - backend-build
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "dev" && $CI_PIPELINE_SOURCE != "schedule"'
#   tags:
#     - docker-runner
```



## Config.toml ÏÑ∏ÌåÖ 

- Gitlab Runner ÏÑ§Ï†ïÏóê ÏÇ¨Ïö©Îê® 
  - docker compose register Ïã§ÌñâÌïòÎ©¥ runner Ïª®ÌÖåÏù¥ÎÑàÏóê Ìï¥Îãπ ÏÑ∏ÌåÖÏù¥ Îì±Î°ùÎê® 

- [runners.docker] : Job Container ÏÑ§Ï†ïÏóê ÏÇ¨Ïö©Îê® 

```toml
concurrent = 4
check_interval = 0
connection_max_age = "15m0s"
shutdown_timeout = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "docker-compose-runner"
  url = "http://[IP:Port]/"
  id = 30
  token = "[GitLab Runner Token]"
  token_obtained_at = 2025-07-28T00:02:23Z
  token_expires_at = 0001-01-01T00:00:00Z
  executor = "docker"
  cache_dir   = "/cache"     # ‚Üê Ï∫êÏãú Ï†ÄÏû•/Î≥µÏõê ÎîîÎ†âÌÜ†Î¶¨ ÏßÄÏ†ï
  [runners.cache]
    Type = "directory"
    Path = "/cache"
    MaxUploadedArchiveSize = 0
    [runners.cache.s3]
    [runners.cache.gcs]
  [runners.docker] # Job Container ÏÑ§Ï†ï
    tls_verify   = false
    image        = "alpine:3.19"
    privileged   = true
    volumes      = [
      "/var/run/docker.sock:/var/run/docker.sock",
      "/home/git-runner/runner-cache:/cache",        	# Job Ïª®ÌÖåÏù¥ÎÑà Ï∫êÏãú Ï†ÑÏö© Î≥ºÎ•® ÎßàÏö¥Ìä∏(Î°úÏª¨Ìò∏Ïä§Ìä∏ÏôÄ Îß§Ìïë)
      "/mnt/c/build/backend:/output/backend",		# Build ÌååÏùº ÎßàÏö¥Ìä∏ (Ìò∏Ïä§Ìä∏ - Job Container Í∞Ñ ÎßàÏö¥Ìä∏)
      "/mnt/c/build/frontend:/output/frontend"
    ]
    shm_size     = 0
```

## Dokcer Compose ÏÑ∏ÌåÖ

### Register

- gitlab runner Î•º Gitlab ÏÑúÎ≤ÑÏùò Îü¨ÎÑàÏôÄ Ïó∞Í≤∞

```yml
services:
  gitlab-runner-register:
    container_name: gitlab-runner-register
    image: gitlab/gitlab-runner:latest
    restart: "no"
    volumes: # Host ÏôÄ runner Ïª®ÌÖåÏù¥ÎÑà Í∞Ñ Ïó∞Í≤∞ 
      - './config:/etc/gitlab-runner'               # Runner Ïª®ÌÖåÏù¥ÎÑà ÏÑ§Ï†ï ÌååÏùº
      - '/var/run/docker.sock:/var/run/docker.sock'
    command: 
      gitlab-runner register
      --non-interactive
      --url http://10.10.30.238:8980/
      --registration-token glrt-ypLtGX5nK5v6paMzyPnm
      --executor docker
      --docker-image alpine:3.19
      --locked=false
      --name p2
      --docker-volumes /var/run/docker.sock:/var/run/docker.sock
```

### Run

- Gitlab Runner Container Î•º Ïã§Ìñâ 

```yml
services:
  gitlab-runner-run:
    container_name: gitlab-runner-run
    image: 'gitlab/gitlab-runner'
    restart: always
    volumes:
      - './config:/etc/gitlab-runner'
      - '/var/run/docker.sock:/var/run/docker.sock'
    command:
      - run
```

## PipeLine Í≤∞Í≥º 

1. Build

   <img src="./images/build_pipeLine.png" width="600">

2. Deploy

   <img src="./images/depoly_pipeLine.png" width="600">





